<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CATÁLOGO - PRONTA ENTREGA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="logo-container">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
    </div>

    <div class="header-container">
        <h1>CATÁLOGO - PRONTA ENTREGA</h1>

        <div class="filtros">
            <form method="get" action="/" class="filtros-form">

                <!-- █████████████████████████████████████████████████ -->
                <!--      Filtro Família – ATUALIZADO                 -->
                <!-- █████████████████████████████████████████████████ -->
                <div class="filtro-item">
                    <label for="marca">Família:</label>

                    <select name="marca" id="marca" multiple size="1" onchange="controleFamilias()">
                        <option value="Todas"
                            {% if not filtro_marca or 'Todas' in filtro_marca %}selected{% endif %}>
                            Todas
                        </option>

                        {% for marca in marcas %}
                        <option value="{{ marca }}"
                            {% if filtro_marca and marca in filtro_marca %}selected{% endif %}>
                            {{ marca }}
                        </option>
                        {% endfor %}
                    </select>

                    <input type="hidden" id="marca_hidden" name="marca_hidden"
                           value="{{ ','.join(filtro_marca) if filtro_marca else '' }}">
                </div>

                <script>
                function controleFamilias() {
                    const select = document.getElementById("marca");
                    const hidden = document.getElementById("marca_hidden");

                    let selecionadas = [...select.options]
                        .filter(o => o.selected)
                        .map(o => o.value);

                    // Se selecionar qualquer categoria → remove "Todas"
                    if (selecionadas.includes("Todas") && selecionadas.length > 1) {
                        select.options[0].selected = false; // remove "Todas"
                        selecionadas = selecionadas.filter(v => v !== "Todas");
                    }

                    // Se nada ficou selecionado → marca "Todas"
                    if (selecionadas.length === 0) {
                        select.options[0].selected = true;
                        selecionadas = ["Todas"];
                    }

                    // Atualiza o campo hidden
                    hidden.value = selecionadas.join(",");

                    // Envia o formulário
                    select.form.submit();
                }
                </script>
                <!-- █████████████████████████████████████████████████ -->

                <!-- Filtro Produto -->
                <div class="filtro-item">
                    <label for="produto">Produto:</label>
                    <select name="produto" id="produto" onchange="this.form.submit()">
                        <option value="">Todos</option>
                        {% if filtro_marca %}
                            {% for produto_option in produtos_disponiveis %}
                                <option value="{{ produto_option }}" {% if produto_option == filtro_produto %}selected{% endif %}>
                                    {{ produto_option }}
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- ⭐⭐⭐ NOVO FILTRO — IMAGEM ⭐⭐⭐ -->
                <div class="filtro-item">
                    <label for="imagem">Imagem:</label>
                    <select name="imagem" id="imagem" onchange="this.form.submit()">
                        <option value="" {% if not filtro_imagem %}selected{% endif %}>Todos</option>
                        <option value="com" {% if filtro_imagem == 'com' %}selected{% endif %}>COM IMAGEM</option>
                        <option value="sem" {% if filtro_imagem == 'sem' %}selected{% endif %}>SEM IMAGEM</option>
                    </select>
                </div>
                <!-- ⭐⭐⭐ FIM DO NOVO FILTRO ⭐⭐⭐ -->

                <!-- Pesquisa -->
                <div class="filtro-item">
                    <label for="pesquisa">Pesquisar Produto:</label>
                    <input type="text" id="pesquisa" name="pesquisa" value="{{ pesquisa }}" placeholder="Digite o nome do produto">
                </div>

            </form>
        </div>
    </div>

    <div class="container">
        {% for produto in produtos %}
        <div class="card">
            {% if produto.IMAGEM_PRODUTO %}
                <img src="{{ produto.IMAGEM_PRODUTO }}" alt="{{ produto.DESCRICAO_PRODUTO }}" class="zoomable">
            {% else %}
                <img src="{{ url_for('static', filename='IMAGENS_PRODUTOS/SEM IMAGEM.jpg') }}" alt="Sem imagem" class="zoomable">
            {% endif %}

            <h2>{{ produto.DESCRICAO_PRODUTO }}</h2>

            <div class="info">
                <p><strong>Código do Produto:</strong> {{ produto.CODIGO_PRODUTO }}</p>
                <p><strong>Marca:</strong> {{ produto.MARCA }}</p>

                <p class="info-medidas">
                    {% set medidas = [] %}
                    {% if produto.COMPRIMENTO|float != 0 %}{% set _ = medidas.append('Comp.: ' ~ '%.2f'|format(produto.COMPRIMENTO|float)|replace('.00','')) %}{% endif %}
                    {% if produto.LARGURA|float != 0 %}{% set _ = medidas.append('Larg.: ' ~ '%.2f'|format(produto.LARGURA|float)|replace('.00','')) %}{% endif %}
                    {% if produto.ALTURA|float != 0 %}{% set _ = medidas.append('Alt.: ' ~ '%.2f'|format(produto.ALTURA|float)|replace('.00','')) %}{% endif %}
                    {% if produto.DIAMETRO|float != 0 %}{% set _ = medidas.append('Ø Diâm.: ' ~ '%.2f'|format(produto.DIAMETRO|float)|replace('.00','')) %}{% endif %}
                    {{ medidas | join(' | ') }}
                </p>

                <div class="precos">
                    {% if produto.DE %}
                        <span class="de">De: R$ {{ produto.DE }}</span>
                    {% endif %}
                    <span class="por">Por: R$ {{ produto.POR }}</span>
                </div>

                <p class="estoque"><strong>Estoque:</strong> {{ produto.ESTOQUE }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="modal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modal-img">
    </div>

<script>
/* -------- MODAL IMAGEM -------- */
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modal-img");
document.querySelectorAll(".zoomable").forEach(img => {
    img.addEventListener("click", () => {
        modal.style.display = "block";
        modalImg.src = img.src;
    });
});
document.querySelector(".close").addEventListener("click", () => modal.style.display = "none");
modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

/* -------- PESQUISA (debounce) -------- */
let timeout;
document.getElementById('pesquisa').addEventListener('input', function() {
    clearTimeout(timeout);
    timeout = setTimeout(() => { this.form.submit(); }, 500);
});
</script>

</body>
</html>


